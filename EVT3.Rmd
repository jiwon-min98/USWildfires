---
title: "Untitled"
author: "Ji Won"
date: "4/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(maps)
library(maptools)
library(mgcv)
library(extRemes)
library(ROCR)
```


```{r, echo = FALSE }

load("~/Desktop/Project/data_train.RData")
data_train_DF<- data_train_DF %>%
  mutate(wind = sqrt(clim1^2 + clim2^2)) %>%
  dplyr::rename(dew_temp = clim3,
         temp = clim4,
         pot_evap = clim5,
         solar_rad = clim6,
         thermal_rad = clim7,
         pressure = clim8,
         evap = clim9,
         precip = clim10) %>%
  subset(select = -c(clim1, clim2) )

dat_scaled <- as.data.frame(scale(data_train_DF[,c(8:36)]))
dat_scaled <- cbind(data_train_DF[,c(1:7)], dat_scaled)

train_data <- filter(dat_scaled, year == 1995| year== 2005 | year ==2015)
test <- filter(dat_scaled, year == 1997 | year == 2007)

train_data<- train_data%>%
  group_by(lon, lat, month)%>%
  mutate(mean_monthly_BA= mean(BA))

train_data<- train_data%>%
  group_by(lon, lat, month)%>%
  mutate(mean_monthly_CNT= mean(CNT))

for (m in 3:9){
  for (L in seq(-124.75, -66.75, 0.5)){
    for (l in seq(25.25, 49.25, 0.5)){
      test$mean_monthly_BA[test$lon==L & test$lat==l & test$month==m] <- 
        train_data$mean_monthly_BA[train_data$lon==L & train_data$lat==l & train_data$month==m][1]
      test$mean_monthly_CNT[test$lon==L & test$lat==l & test$month==m] <- 
        train_data$mean_monthly_CNT[train_data$lon==L & train_data$lat==l & train_data$month==m][1]
    }
  }
} 


rm(L, l, m, data_train_DF)

```


```{r}
threshold <- 2000
train_data$overthreshold <- ifelse(train_data$BA > threshold, 1, 0)
test$overthreshold <- ifelse(test$BA > threshold, 1, 0)
```


# LOGISTIC REGRESSION FOR (BA > THRESHOLD)

## glm

```{r}

overthreshold_glm <- glm(formula = overthreshold ~ month + year + lon+ lat + thermal_rad + altiSD +  wind +altiMean + lc18 + lc1 + lc7 + lc8 +lc15 + lc5 + lc12 + mean_monthly_BA + mean_monthly_CNT, family = binomial, data = train_data)

summary(overthreshold_glm)



overthresholdpredict <- predict(overthreshold_glm, newdata = test, type = "response") #predicting prb that BA > threshold
head(overthresholdpredict)

test$overthresholdpredict <- overthresholdpredict



filter(test, overthresholdpredict > 0.1 & CNT !=0 )
filter(test, overthresholdpredict > 0.1 & BA > 2000)

filter(test, overthreshold == 1)



```

## gam
```{r}
overthreshold_bam <- bam(overthreshold ~ s(month, k=7)+te(lat,lon) + s(temp) + s(pressure) + s(precip) + s(pot_evap)+ s(solar_rad) + s(wind) + s(mean_monthly_BA), data = train_data, method = "REML", family = binomial)
summary(overthreshold_bam)

overthresholdpredict1 <- predict(overthreshold_bam, newdata = test, type = "response") #predicting prb that BA > threshold
head(overthresholdpredict1)

test$overthresholdpredict1 <- overthresholdpredict1


filter(test, overthresholdpredict1 > 0.1 & CNT !=0 )
filter(test, overthresholdpredict1 > 0.1 & BA > 2000)
filter(test, overthreshold == 1)



```




## random forest


```{r}
library(rpart)
library(rpart.plot)
library(caTools)
library(party)
library(partykit)
library(randomForest)


r_forest <- randomForest(as.factor(overthreshold) ~ CNT+ month + year + lon + lat + thermal_rad +
    area + altiSD + temp + pressure + lc1 + lc2 + lc5 + lc6 +
    lc7 + lc8 + lc9 + lc11 + lc12 + lc13 + lc15 + lc16 + lc18 + mean_monthly_BA +mean_monthly_CNT , data = train_data, 
    ntree=1000, importance=TRUE)


importance(r_forest, type=1)
varImpPlot(r_forest)

rforestprob = predict(r_forest, test, type = "prob")

test$rforestpredict <- NULL
test$rforestprob <- rforestprob


filter(test, rforestprob !=1 & CNT !=0 )
filter(test, rforestprob > 0.1 & BA > 2000)
filter(test, overthreshold == 1)



```

## xgboost
```{r}
library(xgboost)
train_var <- train_data %>% select(-c(BA,CNT,overthreshold))
train_label <- train_data$overthreshold
xgboost <- xgboost(data = as.matrix(train_var), label = train_label, booster = "gblinear", max_depth = 2, eta = 1, nthread = 2, nrounds = 2, eval_metric="logloss", objective = "binary:logistic")

test_var <- test %>% select(-c(BA,CNT,overthreshold,overthresholdpredict,rforestprob))
test_label <- test$overthreshold

xgboostpredict <- predict(xgboost, newdata = as.matrix(test_var))


test$xgboostpredict <- xgboostpredict


filter(test, xgboostpredict > 0.1 & CNT !=0 )
filter(test, xgboostpredict > 0.1 & BA > 2000)
filter(test, overthreshold == 1)

importance_matrix <- xgb.importance(model = xgboost)
print(importance_matrix)


```




# Predicting

## GPD models for predicting extremes

### vglm

```{r}
library(VGAM)

modelvglm <- vglm(BA~.-BA-CNT-overthreshold, family = gpd(threshold = threshold), link = "log", data = train_data, subset = BA > threshold)

```



## Predicting burnt area

### GLM
```{r}

m_glm_all <- glm(log(BA+1)~ year+month+lat+lon+thermal_rad+ altiMean+ altiSD+temp+ solar_rad+ wind+ lc1+lc2+lc3+lc5+lc6+lc7+lc8+lc10+lc11+lc12+lc13+lc15+lc16+lc18, family= "gaussian", data = train_data)
p_glm_all <- predict_ba_prob_gaussian_1(m_glm_all, test)
s <- get_score_ba(p_glm_all, test$BA, u_ba, weights_ba)



train1 <- filter(train_data, BA <= threshold)
m_glm <- glm(log(BA+1)~year+month+lat+lon+thermal_rad+ altiMean+ altiSD+temp+ solar_rad+ wind+ lc1+lc2+lc3+lc5+lc6+lc7+lc8+lc10+lc11+lc12+lc13+lc15+lc16+lc18, family= "gaussian", data = train1)
p_glm <- predict_ba_prob_gaussian_1(m_glm, test)

```


### BAM
```{r}
m_bam_all <- bam(log(BA+1) ~ te(lat,lon) + s(temp) +s(dew_temp) + s(pressure) + s(precip) + s(pot_evap)+s(solar_rad) + s(altiMean, k = 20) + s(area) +s(lc1) + s(lc2, k = 20) + s(lc5)+s(lc7)+  s(lc9)+ s(lc11, k = 20) + s(lc12, k = 20) + s(lc13) + s(lc14) + s(lc16)+ s(lc17)+s(lc18, k = 20), data = train_data, method = "REML", family = gaussian)

p_bam_all <- predict_ba_prob_gaussian_1(m_bam_all, test)
s1 <- get_score_ba(p_bam_all, test$BA, u_ba, weights_ba)

m_bam <- bam(log(BA+1) ~ te(lat,lon) + s(temp) +s(dew_temp) + s(pressure) + s(precip) + s(pot_evap)+s(solar_rad) + s(altiMean, k = 20) + s(area) +s(lc1) + s(lc2, k = 20) + s(lc5)+s(lc7)+  s(lc9)+ s(lc11, k = 20) + s(lc12, k = 20) + s(lc13) + s(lc14) + s(lc16)+ s(lc17)+s(lc18, k = 20), data = train1, method = "REML", family = gaussian)

p_bam <- predict_ba_prob_gaussian_1(m_bam, test)
```


### GBM
```{r}
library(gbm)
m_gbm_all <-  gbm(log(BA+1) ~ .-CNT-mean_monthly_BA-overthreshold, data = train_data, distribution = "gaussian", interaction.depth = 6, n.trees=1000, n.minobsinnode = 10, shrinkage = 0.1)

p_gbm_all <- predict_ba_prob_gaussian_gbm1(m_gbm_all, test)
s2 <- get_score_ba(p_gbm_all, test$BA, u_ba, weights_ba)

m_gbm <- gbm(log(BA+1) ~ .-CNT-mean_monthly_BA-overthreshold, data = train1, distribution = "gaussian", interaction.depth = 6, n.trees=1000, n.minobsinnode = 10, shrinkage = 0.1)

p_gbm <- predict_ba_prob_gaussian_gbm1(m_gbm, test)


```

```{r}
s2
```





# predictions

## Using glm logistic & vglm GPD for over threshold & glm gaussian for BA

```{r}
new_glm <- test %>% filter(overthresholdpredict > 0.10 & CNT != 0) 
rows_glm <- which(test$overthresholdpredict > 0.10 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_glm) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_glm), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_glm$overthresholdpredict[i]
}

a <- p_glm

a[rows_glm, 22:28] <- a[rows_glm, 21] + prob_threshold

p1 <- a
q <- a[rows_glm,28] -1
a[rows_glm,] <- p1[rows_glm, ]- q

for (i in 1:24521){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}

for (i in 1:nrow(test)){
  if (test$CNT[i] == 0){
    for (j in 1:ncol(p_glm))
      a[i,j] = 1
  }
}

score_glm <- get_score_ba(a, test$BA, u_ba, weights_ba)

```


## Using glm logistic & vglm GPD for over threshold & gam gaussian for BA (score_glm1)

```{r}
new_glm <- test %>% filter(overthresholdpredict > 0.1 & CNT != 0) 
rows_glm <- which(test$overthresholdpredict > 0.1 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_glm) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_glm), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_glm$overthresholdpredict[i]
}

a <- p_bam


a[rows_glm, 22:28] <- a[rows_glm, 21] +prob_threshold


p1 <- a
q <- a[rows_glm,28] -1
a[rows_glm,] <- p1[rows_glm, ]- q




for (i in 1:24521){
  for(j in 1:28){
    if (a[i,j] < 0) {
     a[i,j] <- 0
    }
  }
}

for (i in 1:nrow(test)){
  if (test$CNT[i] == 0){
    for (j in 1:ncol(a))
      a[i,j] = 1
  }
}

score_glm1 <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_glm1


```


## Using glm logistic & vglm GPD for over threshold & gbm gaussian for BA (score_glm2)

```{r}
new_glm <- test %>% filter(overthresholdpredict > 0.10 & CNT != 0) 
rows_glm <- which(test$overthresholdpredict > 0.10 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_glm) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_glm), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_glm$overthresholdpredict[i]
}

a <- p_gbm 

a[rows_glm, 22:28] <- a[rows_glm, 21] +prob_threshold


p1 <- a
q <- a[rows_glm,28] -1
a[rows_glm,] <- p1[rows_glm, ]- q

for (i in 1:24521){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}

for (i in 1:nrow(test)){
  if (test$CNT[i] == 0){
    for (j in 1:ncol(a))
      a[i,j] = 1
  }
}

score_glm2 <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_glm2


```


## Using bam logistic & vglm GPD for over threshold & glm gaussian for BA

```{r}
new_bam <- test %>% filter(overthresholdpredict1 < 0.10 & CNT != 0) #rows where prb exceed in threshold > 0.5
rows_bam <- which(test$overthresholdpredict1 < 0.10 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_bam) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_bam), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_bam$overthresholdpredict1[i]
}

a <- p_glm

a[rows_bam, 22:28] <- a[rows_bam, 21] +prob_threshold

p1 <- a
q <- a[rows_bam,28] -1
a[rows_bam,] <- p1[rows_bam, ]- q

for (i in rows_bam){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}

for (i in 1:nrow(test)){
  if (test$CNT[i] == 0){
    for (j in 1:ncol(a))
      a[i,j] = 1
  }
}
score_bam <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_bam
```


## Using random forest & vglm GPD for over threshold & glm gaussian for BA

```{r}
new_rforest <- test %>% filter(rforestprob < 0.5 & CNT !=0) #rows where prb exceed in threshold > 0.5
rows_rforest <- which(rforestprob < 0.5 & test$CNT!=0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_rforest)

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_rforest), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_rforest$rforestprob[i]
}

a <- p_glm

b <- a[rows_rforest, 21] + prob_threshold
a[rows_rforest, 22:28] <- a[rows_rforest, 21] + prob_threshold

p1 <- a
q <- a[rows_rforest, 28] -1
a[rows_rforest,] <- p1[rows_rforest, ]- q

for (i in rows_rforest){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}
score_rforest <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_rforest



```



## Using bam logistic & vglm GPD for over threshold & bam gaussian for BA
```{r}
new_bam <- test %>% filter(overthresholdpredict1 > 0.10 & CNT !=0) #rows where prb exceed in threshold > 0.5
rows_bam <- which(test$overthresholdpredict1 > 0.10 & test$CNT != 0)

predictedvglm1 <- predict(modelvglm1, untransform = TRUE, newdata = new_bam) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_bam), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm1)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm1[i,1] , shape = predictedvglm1[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_bam$overthresholdpredict1[i]
}

a <- p_bam

a[rows_bam, 22:28] <- a[rows_bam, 21] +prob_threshold

p1 <- a
q <- a[rows_bam,28] -1
a[rows_bam,] <- p1[rows_bam, ]- q

for (i in rows_bam){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}
score_bam1 <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_bam1


```


## Using bam logistic & vglm GPD for over threshold & gbm gaussian for BA
```{r}
new_bam <- test %>% filter(overthresholdpredict1 > 0.10 & CNT !=0) #rows where prb exceed in threshold > 0.5
rows_bam <- which(test$overthresholdpredict1 > 0.10 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_bam) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_bam), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_bam$overthresholdpredict1[i]
}

a <- p_gbm

a[rows_bam, 22:28] <- a[rows_bam, 21] +prob_threshold

p1 <- a
q <- a[rows_bam,28] -1
a[rows_bam,] <- p1[rows_bam, ]- q

for (i in rows_bam){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}
score_bam2 <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_bam2

```



## Using xgboost losgistic & gbm gaussian for BA


```{r}
new_xgboost <- test %>% filter(xgboostpredict > 0.10 & CNT !=0) #rows where prb exceed in threshold > 0.5
rows_xgboost <- which(test$xgboostpredict > 0.10 & test$CNT != 0)

predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_xgboost) #predict with gpd the selected rows

u_ba_threshold <- subset(u_ba, u_ba > threshold)

x = matrix(0, nrow(new_xgboost), length(u_ba_threshold))
for (i in 1:nrow(predictedvglm)){
  for (j in 1:length(u_ba_threshold))
    x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2]) 
    #prob that BA <  u_ba_threshold given that BA > threshold
}

prob_threshold = matrix(0, nrow(x), length(u_ba_threshold))
for (i in 1:nrow(x)){
  prob_threshold[i,] <- x[i,] * new_xgboost$xgboostpredict[i]
}

a <- p_gbm

a[rows_xgboost, 22:28] <- a[rows_xgboost, 21] +prob_threshold

p1 <- a
q <- a[rows_xgboost,28] -1
a[rows_xgboost,] <- p1[rows_xgboost, ]- q

for (i in rows_xgboost){
  for(j in 1:28){
    if (a[i,j] < 0) {
      a[i,j] <- 0
    }
  }
}
score_xgboost2 <- get_score_ba(a, test$BA, u_ba, weights_ba)
score_xgboost2

```



<!-- # NEURAL NETWORKS for binary classification > threshold: -->

<!-- ```{r} -->

<!-- library(readr) -->

<!-- predictions_ann <- read_csv("~/Desktop/Project/predictions_ann.csv", col_names = FALSE) -->
<!-- test$ann <- predictions_ann -->


<!-- new_ann <- test %>% filter(ann > 0.05 & CNT !=0) -->
<!-- rows_ann <- which(test$ann > 0.05  & test$CNT != 0) -->




<!-- predictedvglm <- predict(modelvglm, untransform = TRUE, newdata = new_ann) -->

<!-- u_ba_threshold <- subset(u_ba, u_ba > threshold) -->



<!-- x = matrix(0, nrow(new_ann), length(u_ba_threshold)) -->
<!-- for (i in 1:nrow(predictedvglm)){ -->
<!--   for (j in 1:length(u_ba_threshold)) -->
<!--     x[i,j] <- pgpd(u_ba_threshold[j], scale = predictedvglm[i,1] , shape = predictedvglm[i,2])  -->
<!--     #prob that BA <  u_ba_threshold given that BA > threshold -->
<!-- } -->

<!-- prob_threshold = matrix(0, nrow(x), length(u_ba_threshold)) -->
<!-- for (i in 1:nrow(x)){ -->
<!--   prob_threshold[i,] <- x[i,] * new_ann$ann[i] -->
<!-- } -->


<!-- p_glm <- predict_ba_prob_gaussian_1(m_glm, test) -->

<!-- p_glm[rows_ann, 22:28] <- p_bam1[rows_ann, 21] +prob_threshold -->

<!-- p1 <- p_glm -->
<!-- q <- p_bam1[rows_ann,28] -1 -->
<!-- p_bam1[rows_ann,] <- p1[rows_ann, ]- q -->

<!-- for (i in rows_ann){ -->
<!--   for(j in 1:28){ -->
<!--     if (p_glm[i,j] < 0) { -->
<!--       p_glm[i,j] <- 0 -->
<!--     } -->
<!--   } -->
<!-- } -->
<!-- score_ann <- get_score_ba(p_glm, test$BA, u_ba, weights_ba) -->


<!-- ``` -->


```{r}
bench <- glm(log(BA+1) ~.-CNT , data = dat_scaled)


p_Bench<- predict_ba_prob_gaussian_1(bench, test)
s_bench <- get_score_ba(p_Bench, test$BA, u_ba, weights_ba)
s_bench

```






